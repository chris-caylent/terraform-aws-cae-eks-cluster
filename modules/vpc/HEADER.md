# terraform-aws-pyx-vpc

## Summary

Terraform module which creates VPC resources on AWS.

Additionally, the user can also enable and internet gateway and NAT gateways for public subnet communication to private subnets. When `is_prod` is true, the EIPs generated by this module will not be destroyed, this is so IPs allocated for use with production firewalls do not have to be reconfigured if resources need to be reprovisioned.

## Helpful AWS Documentation Links

* [AWS VPCs: How They Work](https://docs.aws.amazon.com/vpc/latest/userguide/how-it-works.html)
* [VPCs using NAT](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Scenario2.html)
* [Network ACLs](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html#nacl-basics)

## Example Usage

```hcl
module "vpc" {
  source = "../../"

  is_prod = false

  cidr               = "10.0.0.0/16"
  availability_zones = ["us-west-2a", "us-west-2b"]
  private_subnets    = ["10.0.1.0/24", "10.0.2.0/24", "10.0.3.0/24"]
  public_subnets     = ["10.0.101.0/24", "10.0.102.0/24", "10.0.103.0/24"]


  map_public_ip_on_launch = true
  enable_dns_hostnames    = true
  enable_dns_support      = true
  enable_nat_gateway      = true
  
  tags = {}
}
```

## External NAT Gateway IPs

By default this module will provision new Elastic IPs for the VPC's NAT Gateways.
This means that when creating a new VPC, new IPs are allocated, and when that VPC is destroyed those IPs are released.

To avoid meeting a EIP usage quota enforced by AWS, it is handy to keep the same IPs even after the VPC is destroyed and re-created.

To that end, it is possible to assign existing IPs to the NAT Gateways.
This prevents the destruction of the VPC from releasing those IPs, while making it possible that a re-created VPC uses the same IPs.

To achieve this, allocate the IPs outside the VPC module declaration as illustrated below.

```hcl
resource "aws_eip" "nat" {
  count = 3

  vpc = true
}
```

Then, pass the allocated IPs as a parameter to this module.

```hcl
module "vpc" {
  source = "../../"

  # The rest of arguments are omitted for brevity

  enable_nat_gateway  = true
  single_nat_gateway  = false
  reuse_nat_ips       = true                    # <= Skip creation of EIPs for the NAT Gateways
  external_nat_ip_ids = "${aws_eip.nat.*.id}"   # <= IPs specified here as input to the module
}
```

Note that in the example we allocate 3 IPs because we will be provisioning 3 NAT Gateways (due to `single_nat_gateway = false` and having 3 subnets).
If, on the other hand, `single_nat_gateway = true`, then `aws_eip.nat` would only need to allocate 1 IP.
Passing the IPs into the module is done by setting two variables `reuse_nat_ips = true` and `external_nat_ip_ids = "${aws_eip.nat.*.id}"`.

## NAT Gateway Scenarios

This module supports three scenarios for creating NAT gateways. Each will be explained in further detail in the corresponding sections.

* One NAT Gateway per availability zone (default behavior)
  * `enable_nat_gateway = true`
  * `single_nat_gateway = false`
  * `one_nat_gateway_per_az = true`
* Single NAT Gateway
  * `enable_nat_gateway = true`
  * `single_nat_gateway = true`
  * `one_nat_gateway_per_az = false`

If both `single_nat_gateway` and `one_nat_gateway_per_az` are set to `true`, then `single_nat_gateway` takes precedence.

### One NAT Gateway per availability zone

If `one_nat_gateway_per_az = true` and `single_nat_gateway = false`, then the module will place one NAT gateway in each availability zone you specify in `var.azs`. There are some requirements around using this feature flag:

* The variable `var.azs` **must** be specified.
* The number of public subnet CIDR blocks specified in `public_subnets` **must** be greater than or equal to the number of availability zones specified in `var.azs`. This is to ensure that each NAT Gateway has a dedicated public subnet to deploy to.

### Single NAT Gateway

If `single_nat_gateway = true`, then all private subnets will route their Internet traffic through this single NAT gateway. The NAT gateway will be placed in the first public subnet in your `public_subnets` block.

## "private" versus "intra" subnets

By default, if NAT Gateways are enabled, private subnets will be configured with routes for Internet traffic that point at the NAT Gateways configured by use of the above options.

If you need private subnets that should have no Internet routing (in the sense of [RFC1918 Category 1 subnets](https://tools.ietf.org/html/rfc1918)), `intra_subnets` should be specified. An example use case is configuration of AWS Lambda functions within a VPC, where AWS Lambda functions only need to pass traffic to internal resources or VPC endpoints for AWS services.

Since AWS Lambda functions allocate Elastic Network Interfaces in proportion to the traffic received ([read more](https://docs.aws.amazon.com/lambda/latest/dg/vpc.html)), it can be useful to allocate a large private subnet for such allocations, while keeping the traffic they generate entirely internal to the VPC.

You can add additional tags with `intra_subnet_tags` as with other subnet types.

## Network Access Control Lists (ACL or NACL)

This module can manage network ACL and rules. Once VPC is created, AWS creates the default network ACL, which can be controlled using this module (`manage_default_network_acl = true`).

Also, each type of subnet may have its own network ACL with custom rules per subnet. Eg, set `public_dedicated_network_acl = true` to use dedicated network ACL for the public subnets; set values of `public_inbound_acl_rules` and `public_outbound_acl_rules` to specify all the NACL rules you need to have on public subnets (see `variables.tf` for default values and structures).

By default, all subnets are associated with the default network ACL.

## Tags

In order to configure the VPC for proper use with EKS clusters and an ALB, you must pass subnet tags to the module like below:

```hcl
  # use shared if your subnets contain EKS and non-EKS resources
  public_subnet_tags = {
    "kubernetes.io/cluster/${cluster_name}" = "shared"
    "kubernetes.io/role/elb"                      = 1
  }

  # use owned if your subnets only contain EKS resources.
  private_subnet_tags = {
    "kubernetes.io/cluster/${cluster_name}" = "owned"
    "kubernetes.io/role/internal-elb"             = 1
  }


```

## Examples

* [Complete VPC](./examples/complete-vpc)
